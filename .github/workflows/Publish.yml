# -v  | --verbosity <LEVEL> # Allowed values are q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic]. The default is minimal.

name: Publish

defaults:
  run:
    shell: bash

on:
  push:
    tags:
      - '**'
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  publish_and_pack:
    name: Publish and pack
    runs-on: ${{ matrix.runtime.os }}
    strategy:
      fail-fast: true
      matrix:
        project:
          - {name: Outbox,       path: Outbox/ConsoleApp/Seedysoft.Outbox.ConsoleApp.csproj}
          - {name: Pvpc,         path: Pvpc/ConsoleApp/Seedysoft.Pvpc.ConsoleApp.csproj}
          - {name: WebComparer,  path: WebComparer/ConsoleApp/Seedysoft.WebComparer.ConsoleApp.csproj}
          - {name: BlazorWebApp, path: BlazorWebApp/Server/Seedysoft.BlazorWebApp.Server.csproj}
        runtime:
          - {name: linux-arm64, os: ubuntu-latest}
          - {name: linux-x64,   os: ubuntu-latest}
          - {name: win-x64,     os: windows-latest}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@main
      - name: Setup dotnet
        uses: actions/setup-dotnet@main
        with:
          dotnet-version: 8
      - name: Build ${{ matrix.project.name }}
        id: build
        run: dotnet build "./src/${{ matrix.project.path }}" -c Release --nologo -v m
      - name: Publish ${{ matrix.project.name }} w/runtime ${{ matrix.runtime.name }}
        id: publish
        if: steps.build.outcome == 'success'
        run: |
          mkdir -p "./${{ matrix.project.name }}.${{ matrix.runtime.name }}"
          dotnet publish "./src/${{ matrix.project.path }}" -o "./${{ matrix.project.name }}.${{ matrix.runtime.name }}" -r "${{ matrix.runtime.name }}" -c Release -p:PublishTrimmed=false --no-restore --nologo --sc -v m
      - name: Pack to ${{ matrix.project.name }}.${{ matrix.runtime.name }}.${{ github.ref_name }}.7z
        id: pack
        if: steps.publish.outcome == 'success'
        run: 7z a -r -t7z "./${{ matrix.project.name }}.${{ matrix.runtime.name }}.${{ github.ref_name }}.7z" "./${{ matrix.project.name }}.${{ matrix.runtime.name }}" *
      - name: Upload artifact ${{ matrix.project.name }}.${{ matrix.runtime.name }}.${{ github.ref_name }}.7z
        if: steps.pack.outcome == 'success'
        uses: actions/upload-artifact@main
        with:
          name: ${{ matrix.project.name }}.${{ matrix.runtime.name }}.${{ github.ref_name }}.7z
          path: ${{ matrix.project.name }}.${{ matrix.runtime.name }}.${{ github.ref_name }}.7z
          compression-level: 0
          if-no-files-found: error # `warn` or `ignore` are also available, defaults to `warn`
    
  release:
    name: Create a release
    needs: publish_and_pack
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@main
      - name: Make download folder
        run: mkdir -p ./artifacts/
      - name: Download published app as artifact
        uses: actions/download-artifact@main
        with:
          path: ./artifacts
      - name: Make Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Release ${{ github.ref_name }}
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: ./artifacts/*/*.7z
