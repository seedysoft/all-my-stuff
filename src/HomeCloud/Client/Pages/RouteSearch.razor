@page "/routesearch"

@using Seedysoft.HomeCloud.Client.ViewModels
@using System.Collections.Immutable;

@inject HttpClient Http
@inject NavigationManager NavManager

<MudGrid Class="d-inline-flex" Justify="Justify.Center">
    <MudItem xs="12">
        <MudText Align="Align.Center" GutterBottom Typo="Typo.h4">Search routes</MudText>
    </MudItem>

    <MudItem xs="12">
        <EditForm Model="@RouteQuery" OnValidSubmit="OnValidSubmitRoutesAsync">
            <MudStack Class="d-flex flex-wrap gap-4" Justify="Justify.SpaceEvenly" Row="true">
                <MudTextField @bind-Value="RouteQuery.Origin" AutoFocus="true" Class="d-flex flex-wrap gap-4" For="@(() => RouteQuery.Origin)" Label="Origin"
                              Placeholder="Select an origin place" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="RouteQuery.Destination" Class="d-flex flex-wrap gap-4" For="@(() => RouteQuery.Destination)" Label="Destination"
                              Placeholder="Select a destination place" Variant="Variant.Outlined" />
                <MudButton ButtonType="ButtonType.Submit" Class="ml-auto" Disabled="@(IsLoadingRoutes || IsLoadingGasStations)" StartIcon="@Icons.Material.Filled.Search"
                           Variant="Variant.Outlined">
                    @if (IsLoadingRoutes)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Processing ...</MudText>
                    }
                    else
                    {
                        <MudText>Find routes</MudText>
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudItem>

    <MudItem xs="12">
        <MudDataGrid @ref="RoutesMudDataGrid" Dense="true" Filterable="true" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                     FilterMode="DataGridFilterMode.ColumnFilterMenu" FixedHeader="true" Items="RoutesObtained" Loading="IsLoadingRoutes" RowClassFunc="RoutesMudDataGridRowClassFunc"
                     RowsPerPage="int.MaxValue" ReadOnly="true" SortMode="SortMode.Multiple" Style="min-height: 145px;">
            <Columns>
                <PropertyColumn Property="x => x.Summary" CellStyle="width: 100%;" />
                <PropertyColumn Property="x => x.DurationText" CellStyle="text-align: right !important; white-space: nowrap; width: 1%;" Title="Duration" />
                <PropertyColumn Property="x => x.DistanceText" CellStyle="text-align: right !important; white-space: nowrap; width: 1%;" Title="Distance" />
                <TemplateColumn CellStyle="text-align: center !important; white-space: nowrap; width: 1%;" Filterable="false" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Href="@context!.Item!.GoogleMapsUri" Icon="@Icons.Material.Sharp.Map" Target="_blank" Title="Show map"></MudIconButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <NoRecordsContent>
                <MudText Align="Align.Center" GutterBottom="true">There is no data</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudItem>

    <MudItem xs="12">
        <MudForm @ref="GasStationMudForm" Model="@GasStationQuery">
            <MudStack Class="d-flex flex-wrap gap-4" Justify="Justify.SpaceEvenly" Row="true">
                <MudNumericField @bind-Value="GasStationQuery.MaxDistanceInKm" Class="d-flex flex-wrap gap-4" For="@(() => GasStationQuery.MaxDistanceInKm)" Format="F1" FullWidth="false"
                                 Label="Max distance (km)" Max="50M" Min=".5M" Step=".5M" Style="width: 150px;" Variant="Variant.Outlined" />
                <MudSelect @bind-SelectedValues="PetroleumProductsSelected" @bind-Value="PetroleumProductsSelectedValue" Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.LocalGasStation" Class="d-flex flex-grow-1 gap-4" Clearable="true" Dense="true" FullWidth="true" Label="Products"
                           MultiSelection="true" MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectionText))" SelectAll="true" Strict="true" Style="min-width: 300px;"
                           T="IdDescRecord" ToStringFunc="@IdDescRecord.IdDescRecordConverter" Variant="Variant.Outlined">
                    @foreach (IdDescRecord item in PetroleumProducts ?? ImmutableArray<IdDescRecord>.Empty)
                    {
                        <MudSelectItem T="IdDescRecord" Value="@item">@item.Desc</MudSelectItem>
                    }
                </MudSelect>
                <MudButton Class="ml-auto" Disabled="@(IsLoadingRoutes || IsLoadingGasStations)" OnClick="OnSubmitGasStationsAsync" StartIcon="@Icons.Material.Filled.Search"
                           Variant="Variant.Outlined">
                    @if (IsLoadingGasStations)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Processing ...</MudText>
                    }
                    else
                    {
                        <MudText>Find gas stations</MudText>
                    }
                </MudButton>
            </MudStack>
        </MudForm>
    </MudItem>

    <MudItem xs="12">
        <MudDataGrid Dense="true" Filterable="true" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" FilterMode="DataGridFilterMode.ColumnFilterMenu" FixedHeader="true"
                     Items="@GasStations" Loading="IsLoadingGasStations" RowsPerPage="int.MaxValue" ReadOnly="true" SortMode="SortMode.Multiple">
            <Columns>
                <PropertyColumn Property="x => x.Estacion" CellStyle="width: 100%;" Title="Gas Station" />
                <PropertyColumn Property="x => x.Producto" CellStyle="white-space: nowrap; width: 1%;" Title="Product" />
                <PropertyColumn Property="x => x.Precio" CellStyle="text-align: right !important; white-space: nowrap; width: 1%;" InitialDirection="SortDirection.Ascending" Title="Price" />
                <PropertyColumn Property="x => x.Localidad" CellStyle="white-space: nowrap; width: 1%;" Title="Locality" />
                <PropertyColumn Property="x => x.Municipio" CellStyle="white-space: nowrap; width: 1%;" Title="Municipality" />
                <PropertyColumn Property="x => x.Provincia" CellStyle="white-space: nowrap; width: 1%;" Title="Province" />
                <TemplateColumn CellStyle="text-align: center !important; width: 1%;" Filterable="false" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Href="@context!.Item!.GoogleMapsUri" Icon="@Icons.Material.Sharp.Map" Target="_blank" Title="Show location"></MudIconButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <NoRecordsContent>
                <MudText Align="Align.Center" GutterBottom="true">There is no data</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudItem>
</MudGrid>
